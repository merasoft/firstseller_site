<!-- src/app/features/catalog/pages/product-detail/product-detail.component.html -->
<div class="min-h-screen flex flex-col">
  <app-header></app-header>

  <main class="flex-1 bg-gray-50">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- Breadcrumbs -->
      <p-breadcrumb [model]="breadcrumbItems" [home]="home" styleClass="mb-4" />

      <div class="flex flex-col gap-2">
        <h1 class="text-lg sm:text-xl font-bold text-gray-900 leading-tight">{{ product.name }}</h1>

        <div class="flex items-center gap-4 mb-3">
          <div class="flex items-center gap-2">
            <div class="flex items-center">
              <div *ngFor="let star of getStars(product.rating)" class="w-4 h-4">
                <ng-container [ngSwitch]="star">
                  <svg *ngSwitchCase="'full'" class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <svg *ngSwitchCase="'half'" class="w-4 h-4 text-yellow-400" viewBox="0 0 20 20">
                    <defs>
                      <linearGradient id="half-grad" x1="0" x2="1" y1="0" y2="0">
                        <stop offset="50%" stop-color="currentColor" />
                        <stop offset="50%" stop-color="#D1D5DB" />
                      </linearGradient>
                    </defs>
                    <path
                      fill="url(#half-grad)"
                      d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                  </svg>
                  <svg *ngSwitchCase="'empty'" class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                </ng-container>
              </div>
            </div>
            <span class="text-xs text-gray-500">
              ( {{ product.reviewsCount }} <span class="hidden sm:inline">{{ product.reviewsCount === 1 ? 'отзыв' : 'отзыва' }} </span>)
            </span>
          </div>

          <div class="flex items-center gap-2">
            <p class="text-xs text-gray-600">Арт: {{ product.article }}</p>
            <button (click)="compareProduct()" class="w-8 h-8 rounded transition-colors hover:bg-gray-100" [class.bg-blue-50]="isInCompare()">
              <i class="text-base fa-solid fa-scale-balanced transition-colors" [class]="isInCompare() ? 'text-blue-500' : 'text-gray-600 hover:text-blue-500'"></i>
            </button>
            <button (click)="shareProduct()" class="w-8 h-8 rounded transition-colors hover:bg-gray-100">
              <i class="text-base text-gray-600 pi pi-share-alt"></i>
            </button>
            <button (click)="addToFavorites()" class="w-8 h-8 rounded transition-colors hover:bg-gray-100" [class.bg-red-50]="isInWishlist()">
              <i class="text-base transition-colors" [class]="isInWishlist() ? 'text-red-500 pi pi-heart-fill' : 'text-gray-600 hover:text-red-500 pi pi-heart'"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Product Main Section -->
      <div class="max-w-screen-2xl flex flex-col xl:flex-row items-stretch gap-6 mb-8">
        <div class="flex-1 md:bg-white rounded-3xl md:shadow-sm md:p-6">
          <div class="product-main-section flex flex-col md:flex-row md:items-start gap-8">
            <!-- Product Images -->
            <div class="galary md:flex-[5] flex gap-4">
              <!-- Thumbnail Images Gallery (Left Side) -->
              <div class="thumbnail-images flex-shrink-0 flex flex-col gap-2 overflow-x-hidden overflow-y-auto pr-1 scrollable">
                <button
                  *ngFor="let image of product.images; let i = index"
                  (click)="selectImage(i)"
                  class="flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 transition-all"
                  [ngClass]="{
                    'border-gray-200': i !== selectedImageIndex,
                    'border-primary-500': i === selectedImageIndex
                  }">
                  <img [src]="image" [alt]="'Product image ' + (i + 1)" class="w-full h-full object-cover" />
                </button>
              </div>

              <!-- Main Image Carousel (Right Side) -->
              <div class="main-image md:aspect-square h-80 md:h-auto rounded-2xl bg-white md:bg-gray-100 py-6 md:py-0 overflow-hidden relative">
                <p-carousel
                  [value]="product.images"
                  [numVisible]="1"
                  [numScroll]="1"
                  [circular]="true"
                  [showNavigators]="true"
                  [showIndicators]="false"
                  class="product-carousel"
                  styleClass="rounded-2xl overflow-hidden"
                  [page]="selectedImageIndex"
                  (onPage)="onCarouselPageChange($event)">
                  <ng-template pTemplate="item" let-image>
                    <div class="w-auto md:w-full h-full flex items-center justify-center">
                      <img [src]="image" [alt]="product.name" class="w-auto md:w-full h-full aspect-square md:aspect-auto object-cover" loading="lazy" />
                    </div>
                  </ng-template>
                </p-carousel>
              </div>
            </div>

            <div class="product-info md:flex-[3] flex flex-col">
              <!-- Price -->
              <div class="flex flex-col border-b border-gray-200 pb-4 gap-3">
                <div class="flex flex-col gap-1">
                  <div class="price-info flex md:flex-col items-baseline gap-3 md:gap-0">
                    <span class="text-2xl font-bold text-gray-900">{{ formatPrice(selectedVariant?.price || 0) }} сум</span>
                    <span *ngIf="selectedVariant?.oldPrice" class="text-lg text-gray-500 line-through"> {{ formatPrice(selectedVariant.oldPrice) }} сум </span>
                  </div>
                  <div class="text-sm font-medium text-green-600">+ {{ formatPrice(product.bonusPoints) }} бонусов</div>
                </div>

                <div class="max-w-88 md:max-w-full bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-lg p-2">
                  <div class="text-orange-600 font-medium text-xs">Выгодная рассрочка:</div>
                  <div class="text-orange-700 text-base font-bold"> от {{ formatPrice(selectedInstallmentPlan.monthlyPayment + selectedPaymentProvider.additionalFee) }} сум / мес* </div>
                </div>
              </div>

              <!-- Color & Memory Selection -->
              <div class="flex flex-col gap-3 py-3">
                <!-- Color -->
                <div class="flex flex-col gap-2">
                  <label class="block text-sm font-medium text-gray-900">Цвет: {{ selectedColor }}</label>
                  <div class="flex gap-2">
                    <button
                      *ngFor="let color of getAvailableColors()"
                      (click)="selectColor(color)"
                      class="w-8 h-8 rounded-full border-2 transition-all relative"
                      [style.background-color]="getColorCode(color)"
                      [class.border-primary-500]="selectedColor === color"
                      [class.border-gray-300]="selectedColor !== color"
                      [class.opacity-50]="!isColorAvailable(color)"
                      [disabled]="!isColorAvailable(color)">
                      <span *ngIf="selectedColor === color" class="absolute inset-0 flex items-center justify-center">
                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                      </span>
                    </button>
                  </div>
                </div>

                <!-- Memory -->
                <div class="flex flex-col gap-2">
                  <label class="block text-sm font-medium text-gray-900">Память</label>
                  <div class="flex gap-2">
                    <button
                      *ngFor="let memory of getAvailableMemory()"
                      (click)="selectMemory(memory)"
                      class="px-3 py-1.5 border rounded-lg transition-all text-sm"
                      [class.border-primary-500]="selectedMemory === memory"
                      [class.bg-primary-50]="selectedMemory === memory"
                      [class.text-primary-700]="selectedMemory === memory"
                      [class.border-gray-300]="selectedMemory !== memory"
                      [class.opacity-50]="!isMemoryAvailable(memory)"
                      [disabled]="!isMemoryAvailable(memory)">
                      {{ memory }}
                    </button>
                  </div>
                </div>
              </div>

              <!-- Action Buttons - Компактные в один ряд -->
              <div class="flex flex-col gap-4 py-4 max-w-88 md:max-w-full">
                <div class="flex items-stretch gap-4">
                  <button
                    (click)="quantity == 0 && addToCart()"
                    class="cart-button flex-1 bg-gradient-to-r from-primary-500 to-primary-600 text-sm lg:base text-white py-2 lg:py-3 rounded-lg font-semibold transition-all flex items-center justify-center gap-2"
                    [ngClass]="{ 'hover:from-primary-600 hover:to-primary-700': quantity == 0 }">
                    <i class="pi pi-shopping-cart"></i>
                    <span *ngIf="quantity == 0">В корзину</span>
                    <span *ngIf="quantity > 0">В корзине</span>
                  </button>
                  <div *ngIf="quantity > 0" class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                    <button (click)="decreaseQuantity()" class="w-8 h-full hover:bg-gray-100 transition-colors">
                      <i class="pi pi-minus text-sm"></i>
                    </button>
                    <span class="px-3 text-center text-sm">{{ quantity }}</span>
                    <button (click)="increaseQuantity()" class="w-8 h-full hover:bg-gray-100 transition-colors">
                      <i class="pi pi-plus text-sm"></i>
                    </button>
                  </div>
                </div>

                <button
                  (click)="buyNow()"
                  class="buy-now-button flex-1 bg-white border-2 border-green-500 text-sm lg:base text-green-600 py-2 lg:py-3 rounded-lg font-semibold hover:bg-green-50 transition-all">
                  Купить в один клик
                </button>
              </div>

              <!-- Buy One Click Button -->

              <!-- Benefits - Компактные -->
              <div class="grid grid-cols-2 gap-3 pt-4 border-t border-gray-200">
                <div class="flex items-center gap-2">
                  <div class="w-6 h-6 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="text-xs text-primary-600 pi pi-shield"></i>
                  </div>
                  <div class="text-sm font-medium text-gray-900">Гарантия {{ product.warranty }}</div>
                </div>

                <div class="flex items-center gap-2">
                  <div class="w-6 h-6 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="text-xs text-blue-600 pi pi-box"></i>
                  </div>
                  <div class="text-sm font-medium text-gray-900">Бесплатная доставка</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Installment Plan Section -->
        <div class="installment-plan flex flex-col w-full xl:w-88 bg-white rounded-lg md:rounded-3xl shadow-sm p-3 md:p-6">
          <div class="flex items-center gap-2 mb-4">
            <i class="pi pi-info-circle text-blue-500 cursor-pointer" title="Покупайте товар у удобного для вас партнёра и на подходящий срок рассрочки"></i>
            <h3 class="text-lg font-semibold text-gray-900">Рассрочка платежа</h3>
          </div>

          <!-- Month Selection Tabs -->
          <div class="month-container flex flex-col gap-2">
            <p class="text-sm font-semibold">Месяцы</p>
            <div class="month-tabs flex bg-gray-100 rounded-lg p-1 mb-4">
              <button
                *ngFor="let plan of installmentPlans"
                (click)="selectedInstallmentPlan = plan"
                class="flex-1 py-2 px-3 text-sm font-medium rounded-md transition-all"
                [ngClass]="{
                  'bg-white text-primary-600 shadow-sm': selectedInstallmentPlan.id === plan.id,
                  'text-gray-600 hover:text-gray-900': selectedInstallmentPlan.id !== plan.id
                }">
                {{ plan.months }}
              </button>
            </div>
          </div>

          <!-- Payment Providers -->
          <div class="payment-providers flex flex-col gap-3">
            <button
              *ngFor="let provider of paymentProviders"
              (click)="selectPaymentProvider(provider)"
              class="provider-card flex items-center justify-between p-3 border rounded-lg transition-all cursor-pointer"
              [ngClass]="{
                'border-primary-500 bg-primary-50': selectedPaymentProvider.id === provider.id,
                'border-gray-200 hover:border-primary-300': selectedPaymentProvider.id !== provider.id
              }">
              <div class="flex items-center gap-3">
                <div class="w-12 h-8 flex items-center justify-center">
                  <img [src]="provider.logo" [alt]="provider.name" class="w-full object-cover" />
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-900">{{ formatPrice(selectedInstallmentPlan.monthlyPayment + provider.additionalFee) }} сум</p>
                  <p class="text-xs text-gray-500">в месяц</p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <span
                  class="text-[13px] font-medium transition-colors"
                  [ngClass]="{
                    'text-primary-600': selectedPaymentProvider.id === provider.id,
                    'text-gray-500': selectedPaymentProvider.id !== provider.id
                  }">
                  {{ selectedPaymentProvider.id === provider.id ? 'Выбрано' : 'Выбрать' }}
                </span>
              </div>
            </button>
          </div>

          <!-- Total Amount -->
          <div class="total-amount mt-4 p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600">Общая сумма:</span>
              <span class="text-lg font-semibold text-gray-900">
                {{ formatPrice(selectedInstallmentPlan.totalAmount + selectedPaymentProvider.additionalFee * selectedInstallmentPlan.months) }} сум</span
              >
            </div>
          </div>

          <!-- Main CTA Button -->
          <button
            class="max-w-60 xl:max-w-full xl:w-full ml-auto xl:ml-0 mt-4 bg-orange-500 hover:bg-orange-600 text-sm md:text-base text-white py-2 md:py-3 px-4 rounded-lg font-medium transition-colors">
            Заказать в рассрочку
          </button>
        </div>
      </div>

      <!-- Product Details Tabs -->
      <div class="bg-white rounded-xl shadow overflow-hidden">
        <p-tabs [value]="activeTab" class="product-details-tabs" scrollable>
          <p-tablist>
            <p-tab *ngFor="let tab of tabs" [value]="tab.id">{{ tab.name }}</p-tab>
          </p-tablist>
          <p-tabpanels>
            <!-- Description Tab -->
            <p-tabpanel value="description">
              <div class="flex flex-col p-4">
                <h3 class="text-lg font-bold mb-4">Описание</h3>
                <h4 class="text-base font-semibold mb-2">{{ product.name }}</h4>
                <p class="text-[13px] sm:text-[15px] text-gray-700 leading-relaxed">{{ product.description }}</p>
              </div>
            </p-tabpanel>

            <!-- Specifications Tab -->
            <p-tabpanel value="specifications">
              <div class="flex flex-col gap-6 p-4">
                <div *ngFor="let section of product.specifications">
                  <h3 class="text-base font-bold text-gray-900 mb-4">{{ section.category }}</h3>
                  <div class="grid gap-2 max-w-[600px]">
                    <div *ngFor="let spec of section.items" class="flex justify-between pt-2 pb-1 text-sm sm:text-[15px] border-b border-gray-100 last:border-b-0">
                      <span class="text-gray-600">{{ spec.name }}</span>
                      <span class="font-medium text-gray-900">{{ spec.value }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </p-tabpanel>

            <!-- Reviews Tab -->
            <p-tabpanel value="reviews">
              <div class="text-center px-4 py-10">
                <div class="text-gray-500 mb-4">
                  <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                  </svg>
                  <h3 class="text-base font-medium text-gray-900 mb-2">Пока нет отзывов</h3>
                  <p class="text-sm sm:text-base text-gray-600">Станьте первым, кто оставит отзыв об этом товаре</p>
                </div>
                <button class="bg-primary-600 text-white text-sm sm:text-base px-4 py-2 sm:px-6 sm:py-3 rounded-lg font-medium hover:bg-primary-700 transition-colors"> Оставить отзыв </button>
              </div>
            </p-tabpanel>

            <!-- Payment Tab -->
            <p-tabpanel value="payment">
              <div class="p-4">
                <h3 class="text-lg font-bold mb-4">Способы оплаты</h3>
                <div class="grid md:grid-cols-2 gap-6">
                  <div class="border border-gray-200 rounded-xl p-3">
                    <h4 class="font-semibold mb-2">Онлайн оплата</h4>
                    <p class="text-gray-600 text-sm">Оплата банковскими картами Visa, MasterCard, UzCard</p>
                  </div>
                  <div class="border border-gray-200 rounded-xl p-3">
                    <h4 class="font-semibold mb-2">Наличными при получении</h4>
                    <p class="text-gray-600 text-sm">Оплата наличными курьеру или в пункте выдачи</p>
                  </div>
                </div>
              </div>
            </p-tabpanel>

            <!-- Delivery Tab -->
            <p-tabpanel value="delivery">
              <div class="p-4">
                <h3 class="text-lg font-bold mb-4">Доставка</h3>
                <div class="grid md:grid-cols-2 gap-6">
                  <div class="border border-gray-200 rounded-xl p-3">
                    <h4 class="font-semibold mb-2">Курьерская доставка</h4>
                    <p class="text-gray-600 text-sm">Доставка по Ташкенту в течение 1-2 рабочих дней</p>
                  </div>
                  <div class="border border-gray-200 rounded-xl p-3">
                    <h4 class="font-semibold mb-2">Самовывоз</h4>
                    <p class="text-gray-600 text-sm">Забрать из любого магазина сети Firstseller</p>
                  </div>
                </div>
              </div>
            </p-tabpanel>

            <!-- Discounts Tab -->
            <p-tabpanel value="discounts">
              <div class="p-4">
                <h3 class="text-lg font-bold mb-4">Скидки и бонусы</h3>
                <div class="space-y-4">
                  <div class="border border-gray-200 rounded-xl p-3">
                    <h4 class="font-semibold mb-2">Бонусная программа</h4>
                    <p class="text-gray-600 text-sm">Получайте до 10% бонусов с каждой покупки</p>
                  </div>
                  <div class="border border-gray-200 rounded-xl p-3">
                    <h4 class="font-semibold mb-2">Рассрочка 0-0-12</h4>
                    <p class="text-gray-600 text-sm">Рассрочка без первоначального взноса и переплат</p>
                  </div>
                </div>
              </div>
            </p-tabpanel>
          </p-tabpanels>
        </p-tabs>
      </div>
    </div>
  </main>

  <app-footer></app-footer>
</div>
