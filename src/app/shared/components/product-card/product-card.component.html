<!-- Product Card -->
<article class="h-full flex flex-col bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden relative">
  <!-- Product Link Container -->
  <a [routerLink]="['/catalog/product', product.id]" class="flex-1 flex flex-col">
    <!-- Badge -->
    <div *ngIf="product.badge" class="absolute top-4 left-4 z-10">
      <span class="inline-block text-xs font-bold px-2.5 py-1 rounded-md text-white shadow-sm" [ngClass]="getBadgeClasses(product.badgeType)">
        {{ product.badge }}
      </span>
    </div>

    <!-- Product Image -->
    <div class="relative aspect-square bg-gray-100 overflow-hidden group">
      <img [src]="product.images[product.currentImageIndex]" [alt]="product.name" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy" />

      <!-- Image Navigation (Show on hover) -->
      <div *ngIf="product.images.length > 1" class="absolute inset-0 flex items-center justify-between p-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
        <button
          (click)="previousImage(product); $event.preventDefault(); $event.stopPropagation()"
          class="w-8 h-8 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center hover:bg-white transition-colors shadow-lg">
          <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>

        <button
          (click)="nextImage(product); $event.preventDefault(); $event.stopPropagation()"
          class="w-8 h-8 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center hover:bg-white transition-colors shadow-lg">
          <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>

      <!-- Image Indicators -->
      <div
        *ngIf="product.images.length > 1"
        class="absolute bottom-3 left-1/2 transform -translate-x-1/2 flex items-center gap-1.5 opacity-0 group-hover:opacity-100"
        (click)="$event.stopPropagation()">
        <button
          *ngFor="let image of product.images; let i = index"
          (click)="setImage(product, i); $event.preventDefault(); $event.stopPropagation()"
          class="w-2 h-2 rounded-full transition-all duration-200"
          [ngClass]="{
            'bg-gray-200 hover:bg-gray-300': i !== product.currentImageIndex,
            'bg-primary-500 w-3 h-3': i === product.currentImageIndex,
          }"></button>
      </div>

      <!-- Favorite & Compare -->
      <div class="flex flex-col gap-2 absolute top-3 right-3 translate-x-14 group-hover:translate-x-0 transition-all duration-300">
        <button (click)="onAddToFavorites(product)" class="group/fav action-button" title="В избранное">
          <svg class="w-5 h-5 text-gray-500 group-hover/fav:text-red-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
          </svg>
        </button>

        <button (click)="onAddToCompare(product)" class="group/comp action-button" title="Сравнить">
          <svg class="w-5 h-5 text-gray-500 group-hover/comp:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Product Info -->
    <div class="p-3 sm:p-4 space-y-2 flex-1 flex flex-col">
      <!-- Product Name -->
      <h3 class="text-sm font-medium text-gray-900 line-clamp-2 leading-tight group-hover:text-primary-600 transition-colors">
        {{ product.name }}
      </h3>

      <!-- Rating -->
      <div class="flex items-center gap-2">
        <div class="flex items-center">
          <div *ngFor="let star of getStars(product.rating)" class="w-4 h-4">
            <ng-container [ngSwitch]="star">
              <svg *ngSwitchCase="'full'" class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
              </svg>
              <svg *ngSwitchCase="'half'" class="w-4 h-4 text-yellow-400" viewBox="0 0 20 20">
                <defs>
                  <linearGradient id="half-grad" x1="0" x2="1" y1="0" y2="0">
                    <stop offset="50%" stop-color="currentColor" />
                    <stop offset="50%" stop-color="#D1D5DB" />
                  </linearGradient>
                </defs>
                <path
                  fill="url(#half-grad)"
                  d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
              </svg>
              <svg *ngSwitchCase="'empty'" class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
              </svg>
            </ng-container>
          </div>
        </div>
        <span class="text-xs text-gray-500">
          ( {{ product.reviewsCount }} <span class="hidden sm:inline">{{ product.reviewsCount === 1 ? 'отзыв' : 'отзыва' }} </span>)
        </span>
      </div>

      <!-- Price -->
      <div class="space-y-1 !mt-auto pt-2">
        <div *ngIf="product.oldPrice" class="text-xs sm:text-sm text-gray-500 line-through"> {{ formatPrice(product.oldPrice!) }} сум </div>
        <div class="text-base sm:text-lg font-bold text-gray-900"> {{ formatPrice(product.price) }} сум </div>
      </div>

      <!-- Monthly Payment -->
      <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-md p-1 text-center">
        <div class="text-orange-700 font-normal sm:font-semibold text-[11px] sm:text-sm"> {{ formatPrice(product.monthlyPayment) }} сум × {{ product.installmentMonths }} мес </div>
      </div>
    </div>
  </a>

  <!-- Action Buttons (Outside of link) -->
  <div class="px-3 pb-3 sm:px-4 sm:pb-4 space-y-2">
    <!-- Primary Actions -->
    <div class="flex items-center gap-2">
      <button
        (click)="onBuyOneClick(product)"
        class="flex-1 h-7 sm:h-9 bg-primary-600 hover:bg-primary-700 text-white rounded-md sm:rounded-lg font-medium text-sm transition-all duration-200 hover:transform hover:scale-[1.02]">
        Купить
      </button>

      <button
        (click)="onAddToCart(product)"
        class="w-10 h-7 sm:h-9 bg-green-500 hover:bg-green-600 text-white rounded-md sm:rounded-lg font-medium text-sm transition-all duration-200 hover:transform hover:scale-[1.02] flex items-center justify-center gap-1">
        <i class="pi pi-shopping-cart"></i>
      </button>
    </div>
  </div>
</article>
